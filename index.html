<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechaniq - メカニーク | 車検見積システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 印刷/プレビュー調整モード */
        /* やや詰める (Compact) */
        .print-compact {
            font-size: 0.9em !important;
        }

        .print-compact .preview-table th,
        .print-compact .preview-table td {
            padding: 4px 6px !important;
        }

        .print-compact .preview-section {
            margin: 10px 0 5px !important;
            padding: 4px 8px !important;
            font-size: 1.1em !important;
        }

        .print-compact .preview-info-item {
            margin-bottom: 2px !important;
        }

        .print-compact .preview-title {
            font-size: 1.4em !important;
            margin-bottom: 10px !important;
        }

        /* かなり詰める (Eco) */
        .print-eco {
            font-size: 0.8em !important;
        }

        .print-eco .preview-table th,
        .print-eco .preview-table td {
            padding: 2px 4px !important;
        }

        .print-eco .preview-section {
            margin: 5px 0 5px !important;
            padding: 2px 8px !important;
            font-size: 1em !important;
        }

        .print-eco .preview-info-item {
            margin-bottom: 0px !important;
        }

        .print-eco .preview-title {
            font-size: 1.2em !important;
            margin-bottom: 5px !important;
        }

        /* 限界まで詰める (Super Compact) */
        .print-super-compact {
            font-size: 0.75em !important;
        }

        .print-super-compact .preview-table th,
        .print-super-compact .preview-table td {
            padding: 1px 3px !important;
            line-height: 1.1 !important;
        }

        .print-super-compact .preview-section {
            margin: 3px 0 3px !important;
            padding: 1px 6px !important;
            font-size: 0.95em !important;
        }

        .print-super-compact .preview-info-item {
            margin-bottom: 0px !important;
        }

        .print-super-compact .preview-title {
            font-size: 1.1em !important;
            margin-bottom: 3px !important;
        }

        /* 約款セクション（通常は非表示、JSで制御） */
        #printTerms {
            display: none;
            margin-top: 20px;
            page-break-before: auto;
            /* 必要に応じてJSで制御 */
        }

        #printTerms h4 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            text-align: center;
        }

        #printTerms .terms-content {
            font-size: 0.8em;
            color: #555;
            line-height: 1.4;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }


        /* 印刷用スタイル修正 */
        @media print {
            @page {
                margin: 0;
                size: A4 portrait;
            }

            body {
                margin: 0;
                padding: 0;
                background-color: white;
                -webkit-print-color-adjust: exact;
            }

            /* 全てのUIとモーダルを一旦非表示にする */
            .app-container,
            .container,
            .no-print,
            .modal-overlay,
            .modal,
            h1,
            .input-group,
            .action-buttons,
            #historyContainer,
            .tab-buttons,
            .section-title {
                display: none !important;
            }

            /* プレビューモーダルとそのコンテンツだけを印刷対象にする */
            #previewModal {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                z-index: auto !important;
            }

            /* 印刷プレビュー領域の表示 */
            #printPreview {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                background-color: white;
            }

            /* 固定ページレイアウト用 */
            .print-page {
                width: 100%;
                /* A4高さ: 約1123px - 余白などを考慮して調整
                   1115pxだとギリギリすぎて次ページがあくことがあるため、
                   少し余裕を持って小さくする (1123px - 50px程度) */
                height: 1080px;
                page-break-after: always;
                position: relative;
                /* 印刷時の内部余白 */
                padding: 40px 50px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                /* overflow: hidden; はみ出しを確認できるように一旦外すことも検討だが、レイアウト維持のため残す */
                overflow: hidden;
            }

            .print-page:last-child {
                page-break-after: auto;
            }

            /* ページ内コンテンツの調整 */
            .print-page .header-section {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 30px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }

            .print-page .page-title {
                font-size: 2em;
                font-weight: bold;
                text-align: center;
                margin: 20px 0;
            }

            .print-page .customer-vehicle-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-top: 20px;
            }

            .print-page .info-box {
                border: 1px solid #ccc;
                padding: 15px;
                border-radius: 4px;
            }

            .print-page .info-box h3 {
                margin-top: 0;
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
                font-size: 1.1em;
            }

            /* メンテナンス行 */
            .maintenance-row {
                height: 40px;
                /* 行の高さを固定 */
                border-bottom: 1px solid #ccc;
            }

            .maintenance-row td {
                padding: 0 8px;
                vertical-align: middle;
            }

            /* 約款セクション（最終ページ用） */
            .terms-section {
                margin-top: auto;
                /* ページ下部に押し下げる */
                border: 2px solid #555;
                padding: 20px;
                font-size: 0.85em;
                background-color: #fff;
                flex-grow: 1;
                /* 残りのスペースを埋める */
            }

            /* モーダル関連の強制上書きリセット（念のため） */
            body>#previewModal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
            }

            html,
            body {
                height: auto !important;
                overflow: visible !important;
            }

            /* 4. モーダル内部のスタイルリセット */
            #previewModal .modal-content {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                max-width: none !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            /* .modal-body のスクロール設定を解除（これが白紙の原因） */
            #previewModal .modal-body {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                flex: none !important;
            }

            /* 5. プレビュー本文の表示 */
            #previewContent {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* 6. 印刷用コンテナの余白調整 */
            .print-preview {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                /* パディングをゼロにしてブラウザの余白設定に委ねる、あるいは最小限にする */
                border: none !important;
                box-shadow: none !important;
                min-height: 0 !important;
                /* style.cssのmin-heightを打ち消し */
            }

            /* 不要なUI非表示 */
            .modal-header,
            .modal-footer,
            .modal-close {
                display: none !important;
            }

            /* フォント調整 */
            body {
                font-size: 10pt;
                /* 少し小さくして収まりを良くする */
            }

            /* 改ページ制御 */
            .print-preview {
                page-break-inside: auto;
            }

            table {
                page-break-inside: auto;
                margin-bottom: 20px;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }

            /* 空白ページ対策 */
            * {
                float: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- 認証チェック -->
    <script>
        // ページ読み込み時に認証トークンをチェック
        (function () {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // トークンがない場合はログイン画面にリダイレクト
                window.location.href = 'login.html';
            }
        })();
    </script>

    <div class="app-container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1>🔧 Mechaniq - メカニーク</h1>
                <p>車検見積をスマートに作成</p>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline"
                    style="color:white; border-color:white; background:transparent;"
                    onclick="window.shakenApi.logout()">🚪 ログアウト</button>
            </div>
        </div>
        </header>

        <div class="toolbar">
            <button type="button" class="btn btn-outline" onclick="clearForm()">🗑️ クリア</button>
            <button type="button" class="btn btn-info" onclick="showEstimateHistoryModal()">📊 履歴</button>
            <button type="button" class="btn btn-secondary" onclick="showTemplateModal()">📋 テンプレート</button>
            <button type="button" class="btn btn-success" onclick="saveEstimateToHistory()">💾 見積を保存</button>
            <button type="button" class="btn btn-success" onclick="showJsonImportModal()">📥 車検証JSON</button>
            <select class="form-control" id="documentType" title="書類種別">
                <option value="estimate">📝 見積書</option>
                <option value="invoice">📄 請求書</option>
                <option value="receipt">🧾 領収書</option>
            </select>
            <button type="button" class="btn btn-primary" onclick="showPreview()">👁️ プレビュー</button>
        </div>


        <!-- 会社情報 -->
        <div class="card">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span>🏢 会社情報</span>
                <button type="button" class="btn btn-sm btn-outline"
                    style="color:white;border-color:white;padding:4px 8px;" onclick="showThemeSettingsModal()">🎨
                    デザイン設定</button>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>会社名</label>
                        <input type="text" class="form-control" id="companyName" value="サンプル自動車整備"
                            style="ime-mode: active;">
                    </div>
                    <div class="form-group">
                        <label>電話番号</label>
                        <input type="tel" class="form-control" id="companyTel" value="03-1234-5678">
                    </div>
                </div>
                <div class="form-group">
                    <label>住所</label>
                    <input type="text" class="form-control" id="companyAddress" value="〒123-4567 東京都○○区○○町1-2-3"
                        style="ime-mode: active;">
                </div>
            </div>
        </div>

        <!-- お客様情報 -->
        <div class="card">
            <div class="card-header">👤 お客様情報（車検証情報）</div>
            <div class="card-body">
                <div class="customer-buttons">
                    <button type="button" class="btn btn-primary" onclick="showCustomerListModal()">📂
                        保存済みデータから読み込み</button>
                    <button type="button" class="btn btn-success" onclick="saveCustomerData()">💾 このお客様を保存</button>
                </div>
                <div class="customer-buttons" style="margin-top:8px;">
                    <button type="button" class="btn btn-outline" onclick="exportCustomersToFile()">📥
                        ファイルへエクスポート(ﾅﾝﾊﾞｰﾌﾟﾚｰﾄ打込み必須)</button>
                    <button type="button" class="btn btn-outline" onclick="importCustomersFromFile()">📤
                        ファイルからインポート</button>
                </div>

                <!-- 使用者情報（車検証：使用者欄） -->
                <div class="section-divider"
                    style="margin:16px 0 12px;padding:8px 12px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:8px;">
                    <strong style="color:#1565c0;">🚗 使用者（車検証：使用者欄）</strong>
                    <span style="font-size:0.85em;color:#666;margin-left:8px;">※通常はこちらに車検の請求先を入力</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>使用者氏名/名称 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="userName" placeholder="山田 太郎"
                            style="ime-mode: active;">
                    </div>
                    <div class="form-group">
                        <label>フリガナ</label>
                        <input type="text" class="form-control" id="userNameKana" placeholder="ヤマダ タロウ"
                            style="ime-mode: active;">
                    </div>
                </div>
                <div class="form-group">
                    <label>使用者住所</label>
                    <input type="text" class="form-control" id="userAddress" placeholder="〒000-0000 ○○県○○市..."
                        style="ime-mode: active;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>電話番号</label>
                        <input type="tel" class="form-control" id="userTel" placeholder="000-0000-0000">
                    </div>
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <input type="email" class="form-control" id="userEmail" placeholder="example@email.com">
                    </div>
                </div>

                <!-- 所有者情報（車検証：所有者欄） -->
                <div class="section-divider"
                    style="margin:16px 0 12px;padding:8px 12px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-radius:8px;">
                    <strong style="color:#e65100;">📋 所有者（車検証：所有者欄）</strong>
                    <span style="font-size:0.85em;color:#666;margin-left:8px;">※ローン・リース時は信販会社等</span>
                    <label style="margin-left:12px;font-size:0.9em;"><input type="checkbox" id="ownerSameAsUser"
                            onchange="toggleOwnerSameAsUser()" style="margin-right:4px;">使用者と同じ</label>
                </div>
                <div id="ownerFields">
                    <div class="form-row">
                        <div class="form-group">
                            <label>所有者氏名/名称</label>
                            <input type="text" class="form-control" id="ownerName" placeholder="○○ファイナンス株式会社"
                                style="ime-mode: active;">
                        </div>
                        <div class="form-group">
                            <label>所有者住所</label>
                            <input type="text" class="form-control" id="ownerAddress" placeholder="〒000-0000 ○○県○○市..."
                                style="ime-mode: active;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 車両情報 -->
        <div class="card">
            <div class="card-header">🚙 車両情報</div>
            <div class="card-body">
                <div class="qr-scan-buttons" style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;">
                    <button type="button" class="btn btn-primary" onclick="showQRScannerModal()"
                        style="background:linear-gradient(135deg,#4CAF50,#45a049);">📷 車検証QRコードをスキャン</button>
                    <button type="button" class="btn btn-outline" onclick="importVehicleCertificateJSON()">📄
                        電子車検証データを読み込み</button>
                </div>
                <div class="form-group">
                    <label>ナンバープレート <span class="required">*</span></label>
                    <div class="plate-input">
                        <div class="plate-input">
                            <input type="text" class="form-control" id="plateRegion" placeholder="品川"
                                style="ime-mode: active;">
                            <input type="tel" class="form-control" id="plateClass" placeholder="500"
                                style="ime-mode: disabled;" inputmode="numeric">
                            <input type="text" class="form-control" id="plateHiragana" placeholder="あ"
                                style="ime-mode: active;">
                            <span>-</span>
                            <input type="tel" class="form-control" id="plateSerial" placeholder="1234"
                                style="ime-mode: disabled;" inputmode="numeric">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>メーカー</label>
                        <select class="form-control" id="carMaker" onchange="onMakerChange()">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>車名</label>
                        <select class="form-control" id="carNameSelect" onchange="onCarNameChange()">
                            <option value="">メーカーを先に選択</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>型式</label>
                        <select class="form-control" id="carModelSelect" onchange="onModelChange()">
                            <option value="">車名を先に選択</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>型式（手入力）</label>
                        <input type="text" class="form-control" id="carModel" placeholder="上記にない場合は直接入力">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>型式指定番号</label>
                        <input type="tel" class="form-control" id="typeDesignationNumber" placeholder="12345"
                            inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>類別区分番号</label>
                        <input type="tel" class="form-control" id="categoryClassificationNumber" placeholder="0001"
                            inputmode="numeric">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>車名（表示用）</label>
                        <input type="text" class="form-control" id="carName" placeholder="トヨタ プリウス">
                    </div>
                    <div class="form-group">
                        <label>車台番号</label>
                        <input type="text" class="form-control" id="chassisNumber" placeholder="ZVW50-1234567">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            初度登録年月日
                            <div class="date-input-toggle"
                                style="display:inline-flex;background:#f0f0f0;border-radius:20px;padding:2px;margin-left:8px;">
                                <button type="button" class="date-toggle-btn active" data-mode="seireki"
                                    onclick="toggleDateInputMode('firstRegistration', 'seireki')"
                                    style="padding:4px 12px;border:none;background:#4CAF50;color:white;border-radius:18px;cursor:pointer;transition:all 0.3s;">西暦</button>
                                <button type="button" class="date-toggle-btn" data-mode="wareki"
                                    onclick="toggleDateInputMode('firstRegistration', 'wareki')"
                                    style="padding:4px 12px;border:none;background:transparent;border-radius:18px;cursor:pointer;transition:all 0.3s;">和暦</button>
                            </div>
                        </label>
                        <!-- 西暦入力 -->
                        <input type="date" class="form-control seireki-input" id="firstRegistration"
                            onchange="onSeirekiChange('firstRegistration')">
                        <!-- 和暦入力 -->
                        <div class="wareki-input" id="firstRegistrationWareki"
                            style="display:none;gap:8px;align-items:center;margin-top:8px;">
                            <select class="form-control" id="firstRegistrationEra"
                                onchange="onWarekiChange('firstRegistration')" style="width:80px;padding:6px;">
                                <option value="令和">令和</option>
                                <option value="平成">平成</option>
                                <option value="昭和">昭和</option>
                            </select>
                            <input type="number" class="form-control" id="firstRegistrationYear" min="1" max="99"
                                placeholder="元" onchange="onWarekiChange('firstRegistration')"
                                style="width:60px;padding:6px;">
                            <span>年</span>
                            <select class="form-control" id="firstRegistrationMonth"
                                onchange="onWarekiChange('firstRegistration')" style="width:70px;padding:6px;">
                                <option value="">月</option>
                            </select>
                            <span>月</span>
                            <select class="form-control" id="firstRegistrationDay"
                                onchange="onWarekiChange('firstRegistration')" style="width:70px;padding:6px;">
                                <option value="">日</option>
                            </select>
                            <span>日</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>走行距離</label>
                        <div class="input-with-unit">
                            <input type="number" class="form-control" id="mileage" placeholder="50000">
                            <span>km</span>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>車検区分</label>
                        <select class="form-control" id="shakenType" onchange="updateShakenExpiryDisplay()">
                            <option value="new">新車（初回3年）</option>
                            <option value="continue" selected>継続車検（2年）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>車検満了日（直接入力）</label>
                        <input type="date" class="form-control" id="shakenExpiryDate"
                            onchange="updateShakenExpiryDisplay()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="width:100%;">
                        <div class="shaken-expiry-display" id="shakenExpiryDisplay"
                            style="padding:12px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-radius:8px;text-align:center;font-weight:bold;color:#2e7d32;">
                            車検満了日を入力してください
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>車両重量 <span class="required">*</span></label>
                        <select class="form-control" id="vehicleWeight" onchange="updateLegalFees()">
                            <option value="">選択してください</option>
                            <option value="kei">軽自動車</option>
                            <option value="500">500kg以下</option>
                            <option value="1000">501〜1,000kg</option>
                            <option value="1500">1,001〜1,500kg</option>
                            <option value="2000">1,501〜2,000kg</option>
                            <option value="2500">2,001〜2,500kg</option>
                            <option value="3000">2,501〜3,000kg</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>車両経過年数 <span class="required">*</span></label>
                        <select class="form-control" id="vehicleAge" onchange="updateLegalFees()">
                            <option value="normal">13年未満</option>
                            <option value="ecocar">エコカー減税対象</option>
                            <option value="over13">13年超</option>
                            <option value="over18">18年超</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>工場区分</label>
                        <select class="form-control" id="factoryType" onchange="updateLegalFees()">
                            <option value="designated">指定工場</option>
                            <option value="certified">認証工場（持ち込み）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>OSS申請</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="useOSS" onchange="updateLegalFees()" checked>
                            <label for="useOSS">OSS（ワンストップサービス）を利用する</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 整備内容 -->
        <div class="card">
            <div class="card-header">🔧 整備内容</div>
            <div class="card-body">
                <table class="estimate-table" id="maintenanceTable">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th class="text-center">数量</th>
                            <th class="text-right" style="width: 250px;">単価</th>
                            <th class="text-right">金額（税込）</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="maintenanceItems"></tbody>
                </table>
                <style>
                    .btn-add-sub {
                        width: 30px;
                        height: 30px;
                        border: none;
                        border-radius: 50%;
                        background-color: #007bff;
                        /* Blue */
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        line-height: 1;
                        margin-right: 5px;
                        transition: background-color 0.2s;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding-bottom: 2px;
                    }

                    .btn-add-sub:hover {
                        background-color: #0056b3;
                    }

                    .stacked-input {
                        margin-bottom: 4px;
                    }

                    .stacked-input:last-child {
                        margin-bottom: 0;
                    }
                </style>
                <div class="add-item-row"
                    style="display: grid; grid-template-columns: 2fr 0.6fr 1.5fr 0.8fr; gap: 8px; align-items: center;">
                    <input type="text" class="form-control" id="newItemName" placeholder="項目名を入力">
                    <input type="number" class="form-control qty" id="newItemQty" value="1" min="1">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div style="display: flex; align-items: center; justify-content: flex-end;">
                            <span style="font-size: 0.8em; color: #666; margin-right: 5px;">部品</span>
                            <input type="number" class="form-control price" id="newItemParts" placeholder="0" min="0"
                                style="width: 100px;">
                        </div>
                        <div style="display: flex; align-items: center; justify-content: flex-end;">
                            <span style="font-size: 0.8em; color: #666; margin-right: 5px;">鉱油類</span>
                            <input type="number" class="form-control price" id="newItemFluid" placeholder="0" min="0"
                                style="width: 100px;">
                        </div>
                        <div style="display: flex; align-items: center; justify-content: flex-end;">
                            <span style="font-size: 0.8em; color: #666; margin-right: 5px;">工賃</span>
                            <input type="number" class="form-control price" id="newItemWage" placeholder="0" min="0"
                                style="width: 100px;">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addMaintenanceItem()">➕ 追加</button>
                </div>

                <!-- グローバル値引き設定 -->
                <div
                    style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #fff9e6, #fff3d9); border-radius: 8px; border: 1px solid #ffe082;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #f57c00;">💰 全体一括値引き設定</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 3px;">部品
                                値引率(%)</label>
                            <input type="number" class="form-control" id="globalDiscountParts" value="0" min="0"
                                max="100" oninput="updateGlobalDiscount('parts', this.value)" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 3px;">鉱油類
                                値引率(%)</label>
                            <input type="number" class="form-control" id="globalDiscountFluid" value="0" min="0"
                                max="100" oninput="updateGlobalDiscount('fluid', this.value)" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 3px;">工賃
                                値引率(%)</label>
                            <input type="number" class="form-control" id="globalDiscountWage" value="0" min="0"
                                max="100" oninput="updateGlobalDiscount('wage', this.value)" style="width: 100%;">
                        </div>
                    </div>
                    <div style="font-size: 0.75em; color: #666; margin-top: 6px;">※ 全ての整備項目に適用されます。各項目ごとの値引きと合算されます。
                    </div>
                </div>

                <button type="button" class="btn btn-outline quick-add-btn" onclick="showQuickAddModal()">📋
                    よく使う項目から選択</button>
            </div>
        </div>

        <!-- 法定費用 -->
        <div class="card">
            <div class="card-header">📋 法定費用・諸費用</div>
            <div class="card-body">
                <table class="legal-table">
                    <tr>
                        <td>自動車重量税（1年）</td>
                        <td class="text-right" id="weightTaxDisplay">¥0</td>
                    </tr>
                    <tr>
                        <td>自賠責保険料（24ヶ月）</td>
                        <td class="text-right" id="jibaisekiDisplay">¥0</td>
                    </tr>
                    <tr>
                        <td>印紙代</td>
                        <td class="text-right" id="stampDisplay">¥0</td>
                    </tr>
                    <tr>
                        <td>検査予約手数料</td>
                        <td class="text-right">
                            <input type="number" class="form-control fee-input" id="reservationFee" value="2200"
                                onchange="calculateTotals()">
                        </td>
                    </tr>
                    <tr>
                        <td>代行手数料</td>
                        <td class="text-right">
                            <input type="number" class="form-control fee-input" id="agencyFee" value="11000"
                                onchange="calculateTotals()">
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- 合計金額 -->
        <div class="card summary-card">
            <div class="card-header">💰 合計金額</div>
            <div class="card-body">
                <div class="summary-row">
                    <span>整備費用 小計（税込）</span>
                    <span id="maintenanceSubtotal">¥0</span>
                </div>
                <div class="summary-row">
                    <span>法定費用・諸費用 小計</span>
                    <span id="legalFeesSubtotal">¥0</span>
                </div>
                <div class="summary-row total">
                    <span>お支払い総額</span>
                    <span id="grandTotal">¥0</span>
                </div>
            </div>
        </div>

        <!-- 備考 -->
        <div class="card">
            <div class="card-header">📝 備考・メモ</div>
            <div class="card-body">
                <div class="form-group">
                    <label>見積書備考（見積書に印刷されます）</label>
                    <textarea class="form-control" id="notes" rows="3"
                        placeholder="追加の整備が必要な場合は別途お見積りいたします。"></textarea>
                </div>
                <div class="form-group" style="margin-top:15px;border-top:1px dashed #eee;padding-top:15px;">
                    <label>💬 お客様メモ（社内用・印刷されません）</label>
                    <textarea class="form-control" id="customerMemo" rows="2"
                        placeholder="お客様の好み、次回の提案事項など..."></textarea>
                </div>

                <!-- 写真添付 (サーバー機能) -->
                <div class="form-group" style="margin-top:15px;border-top:1px dashed #eee;padding-top:15px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">📷 車両・部品の写真添付 (サーバー機能)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="vehiclePhotoUpload" accept="image/*" class="form-control"
                            style="width: auto;">
                        <button type="button" class="btn btn-secondary" onclick="uploadSelectedPhoto()">アップロード</button>
                    </div>
                    <div id="uploadedPhotosList" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル: カスタムテーマ設定 -->
    <div class="modal-overlay" id="themeSettingsModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>🎨 デザイン設定</h2>
                <button class="modal-close" onclick="closeThemeSettingsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>テーマカラー</label>
                    <div class="theme-colors" style="display:flex;gap:10px;margin-top:8px;">
                        <div class="theme-color-btn active" style="background:#1a5a8a;"
                            onclick="setThemeColor('#1a5a8a', this)">標準</div>
                        <div class="theme-color-btn" style="background:#2c3e50;"
                            onclick="setThemeColor('#2c3e50', this)">ダーク</div>
                        <div class="theme-color-btn" style="background:#c0392b;"
                            onclick="setThemeColor('#c0392b', this)">レッド</div>
                        <div class="theme-color-btn" style="background:#27ae60;"
                            onclick="setThemeColor('#27ae60', this)">グリーン</div>
                        <div class="theme-color-btn" style="background:#8e44ad;"
                            onclick="setThemeColor('#8e44ad', this)">パープル</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>会社ロゴ画像</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="file" id="companyLogoInput" accept="image/*" style="display:none"
                            onchange="handleLogoUpload(this)">
                        <button class="btn btn-outline btn-sm"
                            onclick="document.getElementById('companyLogoInput').click()">📷 画像を選択</button>
                        <button class="btn btn-outline btn-sm" onclick="clearCompanyLogo()"
                            style="color:#e74c3c;border-color:#e74c3c;">削除</button>
                    </div>
                    <div id="companyLogoPreview"
                        style="margin-top:10px;max-width:200px;border:1px dashed #ddd;padding:5px;display:none;">
                        <img src="" style="width:100%;height:auto;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveThemeSettings()">保存して適用</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 整備項目選択 -->
    <div class="modal-overlay" id="quickAddModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 整備項目を選択</h2>
                <button class="modal-close" onclick="closeQuickAddModal()">×</button>
            </div>
            <button class="modal-close-absolute" onclick="closeQuickAddModal()" style="display: block;">×</button>
            <div class="modal-body">
                <div class="category-tabs" id="categoryTabs"></div>
                <div class="quick-items-list" id="quickItemsList"></div>
            </div>
        </div>
    </div>

    <!-- モーダル: 顧客リスト -->
    <div class="modal-overlay" id="customerListModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📂 保存済みお客様データ</h2>
                <button class="modal-close" onclick="closeCustomerListModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="customerSearch" placeholder="🔍 名前・ナンバー・車名で検索..."
                    oninput="searchCustomers()">
                <div class="customer-list" id="customerListItems"></div>
            </div>
        </div>
    </div>

    <!-- モーダル: プレビュー -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content preview-modal">
            <div class="modal-header">
                <h2>📄 印刷プレビュー</h2>
                <button class="modal-close" onclick="closePreviewModal()">×</button>
            </div>
            <div class="modal-body" id="previewContent"></div>
            <div class="modal-footer" style="justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="printModeSelect" style="font-weight: bold; font-size: 0.9em;">レイアウト設定:</label>
                    <select id="printModeSelect" class="form-control" style="width: auto; padding: 4px 8px;"
                        onchange="setPrintMode(this.value)">
                        <option value="auto" selected>自動 (推奨)</option>
                        <option value="standard">標準</option>
                        <option value="compact">やや詰める (90%)</option>
                        <option value="eco">かなり詰める (80%)</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-outline" onclick="closePreviewModal()">閉じる</button>
                    <button class="btn btn-primary" onclick="shareToLine()" style="background:#06C755;">📱
                        LINEで共有</button>
                    <button class="btn btn-success" onclick="generatePDF()">📄 PDF出力</button>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル: QRコードスキャナー -->
    <div class="modal-overlay" id="qrScannerModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>📷 車検証QRコード読み取り</h2>
                <button class="modal-close" onclick="closeQRScannerModal()">×</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <div
                    style="position:relative;width:100%;max-width:400px;margin:0 auto;background:#000;border-radius:8px;overflow:hidden;">
                    <video id="qrVideo" style="width:100%;height:300px;object-fit:cover;" playsinline></video>
                    <div
                        style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;border:3px solid #4CAF50;border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,0.5);">
                    </div>
                </div>
                <p id="qrStatus" style="margin-top:16px;color:#666;">カメラを起動中...</p>
                <p style="font-size:0.85em;color:#999;margin-top:8px;">💡 車検証のQRコードを枠内に合わせてください</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQRScannerModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 車検期限リマインダー -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>🔔 車検期限リマインダー</h2>
                <button class="modal-close" onclick="closeReminderModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:12px;color:#666;">保存された顧客の車検満了日を期限順に表示します</p>
                <div class="reminder-list" id="reminderListItems" style="max-height:400px;overflow-y:auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeReminderModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 見積履歴 -->
    <div class="modal-overlay" id="estimateHistoryModal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h2>📊 見積履歴</h2>
                <button class="modal-close" onclick="closeEstimateHistoryModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="history-actions" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
                    <input type="text" class="form-control" id="estimateHistorySearch"
                        placeholder="🔍 名前・ナンバー・車名・金額で検索..." oninput="searchEstimateHistory()"
                        style="flex:1;min-width:200px;">
                    <button class="btn btn-success" onclick="saveEstimateToHistory()">💾 現在の見積を保存</button>
                    <button class="btn btn-outline" onclick="saveAsTemplate()">📋 テンプレートとして保存</button>
                </div>
                <div class="estimate-history-list" id="estimateHistoryItems" style="max-height:400px;overflow-y:auto;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEstimateHistoryModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- モーダル: テンプレート -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2>📋 テンプレート一覧</h2>
                <button class="modal-close" onclick="closeTemplateModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:12px;color:#666;">よく使う整備項目セットをテンプレートとして保存・適用できます</p>
                <div class="template-list" id="templateListItems" style="max-height:400px;overflow-y:auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeTemplateModal()">閉じる</button>
                <button class="btn btn-success" onclick="saveAsTemplate()">💾 現在の整備項目を保存</button>
            </div>
        </div>
    </div>

    <!-- モーダル: QRコード -->
    <div class="modal-overlay" id="qrCodeModal">
        <div class="modal-content" style="max-width:400px;text-align:center;">
            <div class="modal-header">
                <h2>📱 QRコード</h2>
                <button class="modal-close" onclick="closeQRCodeModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:16px;color:#666;">お客様のスマホで読み取ると見積内容を確認できます</p>
                <div id="qrCodeDisplay"
                    style="display:inline-block;padding:16px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                </div>
                <pre id="qrCodeText"
                    style="margin-top:16px;padding:12px;background:#f5f5f5;border-radius:8px;text-align:left;white-space:pre-wrap;font-size:0.85em;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQRCodeModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- モーダル: LINE共有ポップアップ -->
    <div class="modal-overlay" id="lineShareModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>📱 LINEで共有</h2>
                <button class="modal-close" onclick="closeLineShareModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:12px;color:#666;">以下のメッセージをコピーしてLINEに貼りけるか、ボタンを押して直接共有してください。</p>
                <textarea class="form-control" id="lineShareText" rows="10" style="font-size:0.9em;margin-bottom:16px;"
                    readonly></textarea>
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button class="btn btn-primary" onclick="copyLineText()" style="flex:1;">📋 コピー</button>
                    <button class="btn btn-success" onclick="openLineApp()" style="flex:1;background:#06C755;">📱
                        LINEを開く</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeLineShareModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- JSON インポートモーダル -->
    <div class="modal" id="jsonImportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📥 車検証JSON読み込み</h3>
                <button class="modal-close" onclick="closeJsonImportModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:16px;color:#666;font-size:0.9em;">
                    📱 iPhoneまたはAndroidの「車検証閲覧アプリ」でICタグを読み取り、<br>
                    JSONファイルをエクスポートして、ここで読み込みます。
                </p>
                <div style="border:2px dashed #ccc;border-radius:8px;padding:24px;text-align:center;margin-bottom:16px;"
                    id="jsonDropZone">
                    <p style="color:#666;margin-bottom:12px;">JSONファイルをここにドラッグ＆ドロップ</p>
                    <p style="color:#999;font-size:0.85em;margin-bottom:12px;">または</p>
                    <label class="btn btn-primary" style="cursor:pointer;">
                        📂 ファイルを選択
                        <input type="file" id="jsonFileInput" accept=".json,application/json" style="display:none;"
                            onchange="handleJsonFileSelect(event)">
                    </label>
                </div>
                <div id="jsonImportResult"
                    style="display:none;padding:12px;background:#e8f5e9;border-radius:8px;margin-top:12px;">
                    <p style="color:#2e7d32;font-weight:600;">✅ 読み込み成功！</p>
                    <pre id="jsonImportPreview" style="margin-top:8px;font-size:0.85em;white-space:pre-wrap;"></pre>
                </div>
                <div id="jsonImportError"
                    style="display:none;padding:12px;background:#ffebee;border-radius:8px;margin-top:12px;">
                    <p style="color:#c62828;font-weight:600;">❌ エラー</p>
                    <p id="jsonImportErrorText" style="color:#c62828;font-size:0.9em;"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeJsonImportModal()">閉じる</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="js/data.js"></script>
    <script src="js/api.js"></script>
    <script src="js/cardb.js"></script>
    <script src="js/main.js"></script>
    <script src="js/wareki.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="js/upload_client.js"></script>
    <script src="js/pdf.js"></script>
</body>

</html>< ! - -   r e l o a d   t r i g g e r   - - > 
     
     