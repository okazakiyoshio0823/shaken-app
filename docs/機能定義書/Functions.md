# 機能定義書 - Mechaniq（メカニーク）

## 機能一覧

### 機能カテゴリ

```
1. 認証機能
2. 会社情報管理機能
3. 顧客情報管理機能
4. 車両情報管理機能
5. 整備見積機能
6. 法定費用計算機能
7. 帳票出力機能
8. データ管理機能
```

---

## 1. 認証機能

### 1.1 ログイン機能

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-LOGIN |
| 機能名 | ユーザーログイン |
| 入力 | ユーザー名、パスワード |
| 処理 | 認証情報の検証、JWTトークン発行 |
| 出力 | 認証トークン、メイン画面へリダイレクト |
| 画面 | `login.html` |

### 1.2 ログアウト機能

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-LOGOUT |
| 機能名 | ログアウト |
| 処理 | ローカルストレージからトークン削除 |
| 出力 | ログイン画面へリダイレクト |

### 1.3 パスワード変更機能

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-CHPWD |
| 機能名 | パスワード変更 |
| 入力 | 現在のパスワード、新しいパスワード |
| 処理 | 現パスワード認証後、新パスワードに更新 |

### 1.4 パスワードリセット機能

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-RESET |
| 機能名 | パスワードリセット |
| 入力 | メールアドレス → リセットトークン → 新パスワード |
| 処理 | リセットトークン発行、有効期限1時間 |
| 画面 | `forgot_password.html`, `reset_password.html` |

### 1.5 2要素認証機能

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-2FA |
| 機能名 | 2要素認証（TOTP） |
| 処理 | QRコード生成、TOTPコード検証 |
| 対応アプリ | Google Authenticator等 |

---

## 2. 会社情報管理機能

### 2.1 会社情報設定

| 項目 | 内容 |
|------|------|
| 機能ID | COMP-INFO |
| 機能名 | 会社情報登録・編集 |
| 入力項目 | 会社名、電話番号、住所 |
| 保存先 | ローカルストレージ |

### 2.2 デザイン設定

| 項目 | 内容 |
|------|------|
| 機能ID | COMP-THEME |
| 機能名 | テーマ・ロゴ設定 |
| 設定項目 | テーマカラー（5色）、会社ロゴ画像 |
| 保存先 | ローカルストレージ |

---

## 3. 顧客情報管理機能

### 3.1 顧客登録機能

| 項目 | 内容 |
|------|------|
| 機能ID | CUST-CREATE |
| 入力項目 | 使用者氏名、フリガナ、住所、電話番号、メール |
| 入力項目 | 所有者氏名、所有者住所（使用者と同じチェック可） |
| 保存先 | サーバーDB（オフライン時はローカルストレージ） |

### 3.2 顧客検索・読み込み機能

| 項目 | 内容 |
|------|------|
| 機能ID | CUST-SEARCH |
| 検索条件 | 名前、ナンバープレート、車名 |
| 処理 | 部分一致検索、結果一覧表示 |

### 3.3 顧客削除機能

| 項目 | 内容 |
|------|------|
| 機能ID | CUST-DELETE |
| 処理 | 確認ダイアログ表示後、削除実行 |
| 関連処理 | 見積データもカスケード削除 |

### 3.4 データエクスポート・インポート機能

| 項目 | 内容 |
|------|------|
| 機能ID | CUST-EXPORT |
| 形式 | JSON形式 |
| インポート時処理 | ナンバープレートで重複判定、更新/新規追加 |

---

## 4. 車両情報管理機能

### 4.1 車両情報入力

| 項目 | 内容 |
|------|------|
| 機能ID | VEH-INPUT |
| 入力項目 | ナンバープレート（地域、分類、かな、番号） |
| 入力項目 | メーカー、車名、型式、車台番号 |
| 入力項目 | 型式指定番号、類別区分番号 |
| 入力項目 | 初度登録年月日、走行距離 |
| 入力項目 | 車検区分、車検満了日 |
| 入力項目 | 車両重量区分、車両経過年数区分 |
| 入力項目 | 工場区分、OSS利用有無 |

### 4.2 メーカー・車名選択機能

| 項目 | 内容 |
|------|------|
| 機能ID | VEH-CARDB |
| 対応メーカー | トヨタ、日産、ホンダ、マツダ、スバル、三菱、スズキ、ダイハツ等 |
| 連動動作 | メーカー→車名→型式の順で選択連動 |
| データソース | `js/cardb.js` |

### 4.3 QRコード読み取り機能

| 項目 | 内容 |
|------|------|
| 機能ID | VEH-QRSCAN |
| 処理 | カメラ起動、QRコード検出・デコード |
| 対象 | 車検証記載のQRコード |
| 使用ライブラリ | jsQR |

### 4.4 電子車検証JSON読み込み機能

| 項目 | 内容 |
|------|------|
| 機能ID | VEH-JSON |
| 処理 | JSONファイルのドラッグ＆ドロップまたは選択 |
| 対象 | 車検証閲覧アプリからエクスポートしたJSON |

---

## 5. 整備見積機能

### 5.1 整備項目選択機能

| 項目 | 内容 |
|------|------|
| 機能ID | MAINT-SELECT |
| カテゴリ | 基本料金、オイル関連、ブレーキ関連、冷却系、ベルト関連 |
| カテゴリ | 電装関連、ワイパー関連、フィルター関連、タイヤ関連、その他 |
| カテゴリ | 診断・見積、エーミング・キャリブレーション |
| データソース | `js/data.js` - `MAINTENANCE_CATEGORIES` |

### 5.2 カスタム項目追加機能

| 項目 | 内容 |
|------|------|
| 機能ID | MAINT-CUSTOM |
| 入力項目 | 項目名、数量、部品代、鉱油類代、工賃 |

### 5.3 項目編集機能

| 項目 | 内容 |
|------|------|
| 機能ID | MAINT-EDIT |
| 編集可能項目 | 数量、部品代、工賃 |
| サブ項目 | 部品明細の追加・編集・削除 |

### 5.4 値引き設定機能

| 項目 | 内容 |
|------|------|
| 機能ID | MAINT-DISC |
| 全体値引き | 部品、鉱油類、工賃それぞれにパーセント指定 |
| 個別値引き | 各項目ごとに値引き率設定可 |

### 5.5 プリセットメニュー機能

| 項目 | 内容 |
|------|------|
| 機能ID | MAINT-PRESET |
| 用途 | ワイパー交換セット、オイル交換セット等の一括追加 |

---

## 6. 法定費用計算機能

### 6.1 重量税自動計算

| 項目 | 内容 |
|------|------|
| 機能ID | LEGAL-WEIGHT |
| 入力パラメータ | 車両重量区分、車両経過年数、軽自動車フラグ |
| 計算ロジック | `js/data.js` - `calculateWeightTax()` |

**重量税テーブル（参考）**

| 重量区分 | エコカー | 13年未満 | 13年超 | 18年超 |
|---------|---------|----------|--------|--------|
| 軽自動車 | ¥5,000 | ¥6,600 | ¥8,200 | ¥8,800 |
| ～500kg | ¥5,000 | ¥8,200 | ¥11,400 | ¥12,600 |
| ～1,000kg | ¥10,000 | ¥16,400 | ¥22,800 | ¥25,200 |
| ～1,500kg | ¥15,000 | ¥24,600 | ¥34,200 | ¥37,800 |
| ～2,000kg | ¥20,000 | ¥32,800 | ¥45,600 | ¥50,400 |
| ～2,500kg | ¥25,000 | ¥41,000 | ¥57,000 | ¥63,000 |
| ～3,000kg | ¥30,000 | ¥49,200 | ¥68,400 | ¥75,600 |

### 6.2 自賠責保険料表示

| 項目 | 内容 |
|------|------|
| 機能ID | LEGAL-JIBAI |
| 保険料 | 普通車: ¥17,650 / 軽自動車: ¥17,540（24ヶ月） |

### 6.3 印紙代自動計算

| 項目 | 内容 |
|------|------|
| 機能ID | LEGAL-STAMP |
| 計算ロジック | `calculateStampFee(isKei, factoryType, useOSS)` |

**印紙代テーブル**

| 区分 | 普通車認証 | 普通車指定 | 普通車OSS | 軽窓口 | 軽OSS |
|------|-----------|-----------|----------|--------|-------|
| 金額 | ¥2,300 | ¥1,800 | ¥1,600 | ¥2,200 | ¥1,100 |

### 6.4 諸費用計算

| 項目 | 内容 |
|------|------|
| 機能ID | LEGAL-MISC |
| 項目 | 検査予約手数料（デフォルト¥2,200） |
| 項目 | 代行手数料（デフォルト¥11,000） |
| 処理 | 手動入力値との合算 |

---

## 7. 帳票出力機能

### 7.1 印刷プレビュー機能

| 項目 | 内容 |
|------|------|
| 機能ID | OUT-PREVIEW |
| ページ構成 | 表紙、整備明細（複数ページ対応）、総括ページ |
| レイアウト設定 | 自動/標準/やや詰める/かなり詰める |

### 7.2 PDF出力機能

| 項目 | 内容 |
|------|------|
| 機能ID | OUT-PDF |
| 使用ライブラリ | html2pdf.js |
| 形式 | A4縦、複数ページ |

### 7.3 書類種別切替

| 項目 | 内容 |
|------|------|
| 機能ID | OUT-DOCTYPE |
| 対応種別 | 見積書、請求書、領収書 |

### 7.4 LINE共有機能

| 項目 | 内容 |
|------|------|
| 機能ID | OUT-LINE |
| 処理 | 見積サマリーのテキスト生成、LINE URLスキーム呼び出し |

---

## 8. データ管理機能

### 8.1 見積履歴機能

| 項目 | 内容 |
|------|------|
| 機能ID | DATA-HISTORY |
| 保存内容 | 顧客情報、車両情報、整備項目、金額 |
| 操作 | 検索、読み込み、削除 |

### 8.2 テンプレート機能

| 項目 | 内容 |
|------|------|
| 機能ID | DATA-TEMPLATE |
| 保存内容 | 整備項目セット |
| 用途 | 定期的な整備パターンの再利用 |

### 8.3 車検期限リマインダー機能

| 項目 | 内容 |
|------|------|
| 機能ID | DATA-REMINDER |
| 表示内容 | 車検満了日の期限順リスト |
| ステータス | 期限切れ/緊急/警告/通常 |

### 8.4 写真添付機能

| 項目 | 内容 |
|------|------|
| 機能ID | DATA-PHOTO |
| 処理 | 画像ファイルのアップロード |
| 保存先 | サーバー `/uploads` ディレクトリ |

---

## 画面一覧

| 画面ID | 画面名 | ファイル | 説明 |
|--------|--------|---------|------|
| SCR-01 | ログイン画面 | login.html | ユーザー認証 |
| SCR-02 | パスワード再設定依頼画面 | forgot_password.html | メール入力 |
| SCR-03 | パスワードリセット画面 | reset_password.html | 新パスワード設定 |
| SCR-04 | メイン画面 | index.html | 見積作成・管理 |

---

## モーダル一覧

| モーダルID | モーダル名 | 用途 |
|------------|-----------|------|
| themeSettingsModal | デザイン設定 | テーマ・ロゴ設定 |
| quickAddModal | 整備項目選択 | カテゴリ別項目選択 |
| customerListModal | 顧客リスト | 保存済み顧客一覧 |
| previewModal | 印刷プレビュー | 見積書プレビュー |
| qrScannerModal | QRスキャナー | 車検証QR読み取り |
| reminderModal | リマインダー | 車検期限一覧 |
| estimateHistoryModal | 見積履歴 | 過去見積一覧 |
| templateModal | テンプレート | 整備項目テンプレート |
| qrCodeModal | QRコード | 見積QRコード表示 |
| lineShareModal | LINE共有 | LINE送信用テキスト |
| jsonImportModal | JSONインポート | 車検証データ読込 |

---

## 更新履歴

| バージョン | 日付 | 更新者 | 内容 |
|-----------|------|--------|------|
| 1.0 | 2026-02-03 | - | 初版作成 |
